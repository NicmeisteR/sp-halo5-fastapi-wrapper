name: Deploy to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Zip application
        run: zip -r app.zip . -x '*.git*'

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: backend
          environment_name: halo-api-env-python
          region: eu-west-1
          version_label: ${{ github.sha }}
          deployment_package: app.zip

      - name: Set environment variable (API Key)
        run: |
          aws elasticbeanstalk update-environment --environment-name halo-api-env-python --option-settings Namespace=aws:elasticbeanstalk:application:environment,OptionName=HALO_API_KEY,Value=${{ secrets.HALO_API_KEY }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: eu-west-1

      - name: Notify EchoNeko Webhook
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            TITLE="Deployment Succeeded"
            BODY="All stages passed."
            PRIORITY="normal"
          else
            TITLE="Deployment Failed"
            BODY="One or more stages failed."
            PRIORITY="high"
          fi
          curl -X POST http://minecraft.nicmeister.cloud:3000/api/webhooks/event \
            -H "Content-Type: application/json" \
            -H "User-Agent: insomnia/2023.5.8" \
            -H "x-api-key: ek_dUrZeRZU6x8MjIneIO6k7g4WkZ2tJ4BqWjhLv5dSIs53UyaY" \
            -d '{
              "user_id": "8c3ff0ae-3804-4792-a404-e9254bc2b66c",
              "title": "'"$TITLE"'",
              "body": "'"$BODY"'",
              "event_type": "event",
              "source": "EchoNeko",
              "priority": "'"$PRIORITY"'",
              "data": {
                "metadata": "GitHub Actions deployment",
                "count": 1,
                "items_count": 3,
                "url": "https://github.com/${{ github.repository }}",
                "commit": "${{ github.sha }}",
                "workflow": "${{ github.workflow }}",
                "run_id": "${{ github.run_id }}",
                "status": "'"$STATUS"'"
              },
              "send_push": true
            }' || true
        continue-on-error: true
